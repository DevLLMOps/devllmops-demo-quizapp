# DevLLMOps: AI adversarial review on PRs
# Uses Claude Haiku for cost efficiency. Switch model for deeper review.

name: AI Review

on:
  pull_request:
    branches: [main]

jobs:
  ai-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get diff
        run: git diff origin/main...HEAD > /tmp/diff.patch

      - name: AI Adversarial Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          DIFF=$(head -c 50000 /tmp/diff.patch)
          if [ -z "$DIFF" ]; then
            echo "No diff found, skipping review."
            echo "No changes to review." > /tmp/review.txt
            exit 0
          fi
          curl -sf https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "$(jq -n \
              --arg diff "$DIFF" \
              '{
                "model": "claude-haiku-4-5-20251001",
                "max_tokens": 2048,
                "messages": [{
                  "role": "user",
                  "content": ("Review this code diff for:\n1. Bugs and logic errors\n2. Security vulnerabilities (OWASP Top 10)\n3. Missing error handling\n4. Missing tests\n\nOnly flag real issues. Be concise.\n\nDiff:\n" + $diff)
                }]
              }')" | jq -r '.content[0].text' > /tmp/review.txt

      - name: Post review comment
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REVIEW=$(cat /tmp/review.txt)
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "## AI Review"$'\n\n'"$REVIEW"
